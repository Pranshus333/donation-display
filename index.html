<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Donation Display</title>
  <style>
    body {
      background-color: #f2f2f2;
      color: #bb0000;
      font-family: "Arial Black", sans-serif;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      flex-direction: column;
      overflow: hidden;
    }

    #amount {
      font-size: 10vw;
      font-weight: bold;
      text-shadow: 2px 2px 20px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s ease-in-out;
    }



    canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }
  </style>
</head>
<body>
  <div id="amount">$0</div>
  <canvas id="confetti-canvas"></canvas>

  <script>
    const API_URL = "https://events.dancemarathon.com/api/events/6631/donations?limit=10";
    let lastDonationId = null;
    let isFirstLoad = true;
    let checkInterval = 30000;
    let intervalId = null;
    let isRateLimited = false;
    let failedAttempts = 0;

    function log(msg) {
      console.log(`[${new Date().toLocaleTimeString()}] ${msg}`);
    }

    function setCheckInterval(newInterval) {
      checkInterval = newInterval;
      if (intervalId) {
        clearInterval(intervalId);
      }
      intervalId = setInterval(checkForNewDonation, checkInterval);
      log(`Poll interval set to ${checkInterval/1000}s`);
    }

    async function checkForNewDonation() {
      try {
        log("Checking API...");
        const res = await fetch(API_URL, { 
          method: 'GET',
          cache: 'no-store',
          headers: { 
            'Accept': 'application/json'
          }
        });
        
        if (!res.ok) {
          const text = await res.text();
          if (text.includes("Rate Limit Exceeded") || res.status === 429) {
            if (!isRateLimited) {
              isRateLimited = true;
              log("Rate limited - slowing down");
              setCheckInterval(30000);
            }
            return;
          }
          log(`HTTP ${res.status}: ${res.statusText}`);
          return;
        }

        if (isRateLimited) {
          isRateLimited = false;
          log("Rate limit cleared");
          setCheckInterval(30000);
        }
        
        failedAttempts = 0;

        const donations = await res.json();
        log(`Got ${donations.length} donations`);

        if (!Array.isArray(donations) || donations.length === 0) {
          return;
        }

        const newestDonation = donations[0];
        const currentDonationId = newestDonation.donationID;
        const donorName = newestDonation.displayName || 'Anonymous';
        const amount = newestDonation.amount;
        
        log(`Latest: ${amount} from ${donorName}`);
        
        if (isFirstLoad) {
          lastDonationId = currentDonationId;
          isFirstLoad = false;
          log("Initialized - watching for new donations");
          return;
        }

        if (currentDonationId !== lastDonationId) {
          log(`NEW DONATION! ${amount} from ${donorName}`);
          lastDonationId = currentDonationId;
          showDonation(amount);
        }

      } catch (err) {
        failedAttempts++;
        log(`Error: ${err.message}`);
        
        if (failedAttempts >= 3) {
          log("Multiple failures - extending wait to 60s");
          setCheckInterval(60000);
        }
        
        console.error("Full error:", err);
      }
    }

    function showDonation(amount) {
      const amountEl = document.getElementById("amount");

      amountEl.textContent = `$${amount.toFixed(2)}`;
      amountEl.style.transform = "scale(1.3)";
      
      setTimeout(() => {
        amountEl.style.transform = "scale(1)";
      }, 400);

      startConfetti();
      setTimeout(stopConfetti, 5000);
    }

    // --- Confetti Animation ---
    const canvas = document.getElementById("confetti-canvas");
    const ctx = canvas.getContext("2d");
    let confetti = [];
    let confettiInterval;

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function startConfetti() {
      confetti = [];
      for (let i = 0; i < 200; i++) {
        confetti.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          r: Math.random() * 6 + 4,
          d: Math.random() * 10 + 5,
          color: randomColor(),
          tilt: Math.random() * 10 - 10
        });
      }
      clearInterval(confettiInterval);
      confettiInterval = setInterval(drawConfetti, 20);
    }

    function stopConfetti() {
      clearInterval(confettiInterval);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function drawConfetti() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      confetti.forEach((c) => {
        ctx.beginPath();
        ctx.fillStyle = c.color;
        ctx.fillRect(c.x + c.tilt, c.y, c.r, c.r);
        ctx.fill();
      });
      updateConfetti();
    }

    function updateConfetti() {
      for (let i = 0; i < confetti.length; i++) {
        const c = confetti[i];
        c.y += Math.random() * 3 + 2;
        c.x += Math.sin(c.d);
        if (c.y > canvas.height) {
          confetti[i] = {
            x: Math.random() * canvas.width,
            y: -10,
            r: c.r,
            d: c.d,
            color: c.color,
            tilt: c.tilt
          };
        }
      }
    }

    function randomColor() {
      const colors = ["#bb0000", "#ffffff", "#666666"];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // Initialize
    log("Starting donation monitor...");
    log(`Checking every ${checkInterval/1000} seconds`);
    checkForNewDonation();
    intervalId = setInterval(checkForNewDonation, checkInterval);
  </script>
</body>
</html>
