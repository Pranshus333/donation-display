<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BuckeyeThon Live Donation Display</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
  
  <style>
    /* OSU Theme Colors */
    :root {
      --osu-scarlet: #bb0000;
      --osu-gray: #666666;
      --white: #ffffff;
      --black: #000000;
      --font-main: 'Oswald', sans-serif; /* A strong, bold font */
    }

    body {
      /* Deep Scarlet to Dark Gray gradient - more OSU-themed */
      background: linear-gradient(135deg, var(--osu-scarlet) 0%, #800000 50%, var(--osu-gray) 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      color: var(--white);
      font-family: var(--font-main);
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      box-sizing: border-box;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* --- Floating Dollar Signs --- */
    #floating-elements {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .buckeye-leaf {
      position: absolute;
      font-size: 2.5rem; 
      color: var(--white); 
      opacity: 0.5; 
      text-shadow: 0 0 5px var(--osu-scarlet), 0 0 10px rgba(0, 0, 0, 0.5); 
      animation: float 25s infinite linear; 
    }
    
    /* Individual element animations for variety */
    .leaf-1 { left: 10%; top: -10%; animation-duration: 25s; animation-delay: 0s; transform: scale(1.2); }
    .leaf-2 { left: 80%; top: -20%; animation-duration: 30s; animation-delay: 5s; transform: scale(0.8); }
    .leaf-3 { left: 30%; top: -5%; animation-duration: 20s; animation-delay: 10s; transform: scale(1.5); }
    .leaf-4 { left: 55%; top: -15%; animation-duration: 35s; animation-delay: 15s; transform: scale(1.0); }
    .leaf-5 { left: 5%; top: -30%; animation-duration: 22s; animation-delay: 8s; transform: scale(1.3); }

    @keyframes float {
      0% { transform: translateY(0) rotate(0deg) translateX(0); opacity: 0; }
      10% { opacity: 0.5; }
      90% { opacity: 0.5; }
      100% { transform: translateY(105vh) rotate(720deg) translateX(50px); opacity: 0; }
    }

    /* --- Main Content --- */
    #container {
      position: relative;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
    }

    /* --- Logo Display (CENTER SQUARE CONTAINER) --- */
    #logo-container {
      width: 200px;
      height: 200px;
      background: var(--white);
      border: 5px solid var(--osu-scarlet);
      border-radius: 10px; /* Square with slight rounding */
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.4), 0 0 10px var(--osu-scarlet);
      padding: 15px;
      box-sizing: border-box;
      margin-bottom: 20px;
      overflow: hidden; 
    }

    #logo-placeholder {
        width: 100%;
        height: 100%;
        display: flex; 
        align-items: center;
        justify-content: center;
    }

    #logo-placeholder img {
      width: 100%;
      height: 100%;
      object-fit: contain; 
    }

    /* --- Donor Name Display (Now Recipient Name) --- */
    #donor-name {
      font-size: 3.5vw; /* Adjusted for visibility */
      font-weight: 700;
      color: var(--white);
      text-shadow: 0 0 10px var(--osu-scarlet);
      letter-spacing: 0.05em;
      min-height: 1em; /* Ensures element doesn't collapse on load */
    }

    /* --- Donation Amount --- */
    #amount {
      font-size: 8vw; /* Reduced font size slightly to fit donor name above */
      font-weight: 700;
      color: var(--white);
      text-shadow: 0 0 20px var(--osu-scarlet), 0 0 10px var(--black);
      transition: transform 0.2s ease-out;
      letter-spacing: 0.08em;
      line-height: 1;
    }

    #amount.highlight {
      transform: scale(1.15) rotate(2deg);
    }

    /* --- Confetti --- */
    canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }
  </style>
</head>
<body>
  
  <div id="floating-elements">
    <div class="buckeye-leaf leaf-1">$</div>
    <div class="buckeye-leaf leaf-2">$</div>
    <div class="buckeye-leaf leaf-3">$</div>
    <div class="buckeye-leaf leaf-4">$</div>
    <div class="buckeye-leaf leaf-5">$</div>
  </div>

  <div id="corner-images">
    </div>

  <div id="container">
    <div id="logo-container">
      <div id="logo-placeholder">
        <img src="./buckeyethon_logo.jpg" alt="BuckeyeThon Main Logo">
        </div>
    </div>
    
    <div id="tagline" style="display:none;"></div>
    
    <div id="donor-name">Watching for Donations...</div>

    <div id="amount">$0.00</div>
  </div>
  
  <canvas id="confetti-canvas"></canvas>

  <script>
    // --- Tracking the latest time instead of ID for robust multi-donation handling ---
    const API_URL = "https://events.dancemarathon.com/api/events/6631/donations?limit=10";
    let lastDonationTime = null; // **CHANGED: Now tracking time**
    let isFirstLoad = true;
    let checkInterval = 1200000;
    let intervalId = null;
    let isRateLimited = false;
    let failedAttempts = 0;

    function log(msg) {
      console.log(`[${new Date().toLocaleTimeString()}] ${msg}`);
    }

    function setCheckInterval(newInterval) {
      checkInterval = newInterval;
      if (intervalId) {
        clearInterval(intervalId);
      }
      intervalId = setInterval(checkForNewDonation, checkInterval);
      log(`Poll interval set to ${checkInterval/1000}s`);
    }

    async function checkForNewDonation() {
      try {
        log("Checking API...");
        const res = await fetch(API_URL, { 
          method: 'GET',
          cache: 'no-store',
          headers: { 
            'Accept': 'application/json'
          }
        });
        
        if (!res.ok) {
          const text = await res.text();
          if (text.includes("Rate Limit Exceeded") || res.status === 429) {
            if (!isRateLimited) {
              isRateLimited = true;
              log("Rate limited - slowing down");
              setCheckInterval(120000); // Wait 2 minutes if rate limited
            }
            return;
          }
          log(`HTTP ${res.status}: ${res.statusText}`);
          return;
        }

        if (isRateLimited) {
          isRateLimited = false;
          log("Rate limit cleared");
          setCheckInterval(30000); // Reset to base 30 seconds
        }
        
        failedAttempts = 0;

        const donations = await res.json();
        log(`Got ${donations.length} donations`);

        if (!Array.isArray(donations) || donations.length === 0) {
          return;
        }

        // --- MULTI-DONATION LOGIC ---
        let newDonations = [];
        let newestTime = lastDonationTime;

        // 1. Iterate backward to process oldest-newest donations in order
        for (let i = donations.length - 1; i >= 0; i--) {
            const donation = donations[i];
            // Convert the UTC string to a number (milliseconds since epoch)
            const donationTime = new Date(donation.createdDateUTC).getTime();
           
            // Check if this donation is strictly newer than the last one we processed
            if (!lastDonationTime || donationTime > lastDonationTime) {
                newDonations.push(donation);
            }
           
            // Always track the newest time found in the current response
            if (!newestTime || donationTime > newestTime) {
                newestTime = donationTime;
            }
        }
        
        // 2. Handle first load and bail
        if (isFirstLoad) {
            lastDonationTime = newestTime;
            isFirstLoad = false;
            log("Initialized - watching for new donations");
            return;
        }
        
        // 3. Process all new donations found
        if (newDonations.length > 0) {
            log(`Found ${newDonations.length} NEW DONATION(S)!`);

            // Use a short delay between alerts for multiple simultaneous donations
            newDonations.forEach((donation, index) => {
                // Recipient display logic
                const recipientName = donation.recipientName || 'A BuckeyeThon Participant';
                const amount = donation.amount;
                
                setTimeout(() => {
                    log(`ALERT: ${amount} for ${recipientName}`);
                    showDonation(amount, recipientName); 
                }, index * 3000); // 3-second delay ensures each donation gets a full screen moment
            });
            
            // 4. Update the tracker time only after all new donations have been handled
            lastDonationTime = newestTime;
        }
        // --- END NEW LOGIC ---

      } catch (err) {
        failedAttempts++;
        log(`Error: ${err.message}`);
        
        if (failedAttempts >= 3) {
          log("Multiple failures - extending wait to 60s");
          setCheckInterval(60000);
        }
        
        console.error("Full error:", err);
      }
    }

    // Function to display a donation
    function showDonation(amount, recipientName) {
      const amountEl = document.getElementById("amount");
      const donorEl = document.getElementById("donor-name");

      // Update to display WHO GOT the donation
      donorEl.textContent = `For ${recipientName}:`;

      // Update amount
      amountEl.textContent = `$${amount.toFixed(2)}`;
      amountEl.classList.add("highlight"); 
      
      setTimeout(() => {
        amountEl.classList.remove("highlight");
      }, 400);

      startConfetti();
      setTimeout(stopConfetti, 5000);
    }

    // --- Confetti Animation (Unchanged) ---
    const canvas = document.getElementById("confetti-canvas");
    const ctx = canvas.getContext("2d");
    let confetti = [];
    let confettiInterval;

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function startConfetti() {
      confetti = [];
      for (let i = 0; i < 200; i++) {
        confetti.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          r: Math.random() * 6 + 4,
          d: Math.random() * 10 + 5,
          color: randomColor(),
          tilt: Math.random() * 10 - 10
        });
      }
      clearInterval(confettiInterval);
      confettiInterval = setInterval(drawConfetti, 20);
    }

    function stopConfetti() {
      clearInterval(confettiInterval);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function drawConfetti() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      confetti.forEach((c) => {
        ctx.beginPath();
        ctx.fillStyle = c.color;
        ctx.fillRect(c.x + c.tilt, c.y, c.r, c.r);
        ctx.fill();
      });
      updateConfetti();
    }

    function updateConfetti() {
      for (let i = 0; i < confetti.length; i++) {
        const c = confetti[i];
        c.y += Math.random() * 3 + 2;
        c.x += Math.sin(c.d);
        if (c.y > canvas.height) {
          confetti[i] = {
            x: Math.random() * canvas.width,
            y: -10,
            r: c.r,
            d: c.d,
            color: c.color,
            tilt: c.tilt
          };
        }
      }
    }

    function randomColor() {
      // BuckeyeThon's colors: Scarlet, White, Gray/Black
      const colors = ["#bb0000", "#ffffff", "#666666"]; 
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // Initialize
    log("Starting donation monitor...");
    log(`Checking every ${checkInterval/1000} seconds`);

    // **FINAL CHANGE: Add 5-second delay to avoid rate limiting on deployment**
    setTimeout(() => {
        checkForNewDonation();
        intervalId = setInterval(checkForNewDonation, checkInterval);
    }, 5000); // Wait 5 seconds before the first check
  </script>
</body>
</html>
